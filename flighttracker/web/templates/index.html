<!doctype html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href='https://fonts.googleapis.com/css?family=Cambay' rel='stylesheet'>
    <title>MyFly</title>
    <style>
        html, body {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            background-color: #1E2224;
            color: white;
            font-family: 'Cambay', Helvetica;
            font-size: 22px;
        }
        .container {
            margin-top: 10px;
            width: 900px;
            padding: 10px;
        }
        .bird {
            width: 50px;
            padding: 10px;
            display: inline-block;
            vertical-align: sub;
            text-align: middle;
        }
        h1 {
            margin: 2px;
            display: inline-block;
            vertical-align: middle
        }
        #about {
            color: inherit;
            text-decoration: none;
        }
        .item {
            width: 150px;
            display: inline-block;
            vertical-align: sub;
            text-align: center;
            font-size: 22px;
        }
        .shadow {
            box-shadow: 0px 10px 10px 0px inset rgba(0, 0, 0, 0.4);
            position: relative;
            margin-left: 300px;
            height: 20px;
            content: "";
            z-index: 3;
        }
        #viewDiv {
            position: absolute;
            padding: 0px;
            margin-left: 300px;
            height: 96%;
            width: 77%;
            z-index: 1;
        }
        .esri-popup__header {
            color: #ffffff;
            cursor: default;
            line-height: 20px;
            background: rgba(30, 34, 36, 1) !important;
        }
        #feature-node {
            position: absolute;
            float: left;
            width: 300px;
            height: 100%;
            padding: 0em;
            z-index: 2;
            color: inherit;
            background: rgba(18, 20, 21, 0.5)
        }
        .esri-feature__size-container {
            padding: 20px;
        }
        .footer {
            text-align: center;
            font-size: 8px;
            color: grey;
            position: absolute;
            bottom: 5px;
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://kit.fontawesome.com/2ddda9be5b.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"
            integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I="
            crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://js.arcgis.com/4.16/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.16/"></script>


    <script type="text/javascript">
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/widgets/Feature",
            "esri/layers/FeatureLayer"
            ], function(Map, MapView, Graphic, Feature, FeatureLayer) {

                var map = new Map({
                    basemap: "dark-gray-vector"
                });

                var view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [0, 20], // longitude, latitude
                    zoom: 1,
                    popup: {
                        autoOpenEnabled: false
                    },
                    highlightOptions: {
                        color: [255, 255, 255, 1],
                        haloOpacity: 0.5,
                        fillOpacity: 0.5
                    }
                });

                var marker = {
                    type: "picture-marker",
                    url: "{{  url_for('static', filename='icon.svg') }}",
                    angle: 0
                };

                fields = [{
                    name: "Icao24",
                    type: "oid"
                }, {
                    name: "Origin_country",
                    type: "string"
                }, {
                    name: "Longitude",
                    type: "double"
                }, {
                    name: "Latitude",
                    type: "double"
                }, {
                    name: "True_track",
                    type: "double"
                }];

                const rotationRenderer = {
                    type: "simple",
                    symbol: marker,
                    visualVariables: {
                        type: "rotation",
                        field: "True_track",
                        rotationType: "geographic"
                    }
                };

                let points = {};
                let pointGraphics = {};
                let attributes = {};
                let popupTemplates = {};

                const vector = {
                    Icao24: "lf324",
                    Origin_country: "Tralyandiya",
                    Longitude: 0,
                    Latitude: 20,
                    True_track: 89
                };

                points = {
                    type: "point",
                    longitude: vector["Longitude"],
                    latitude: vector["Latitude"]
                };

                attributes = {
                    Icao24: vector.Icao24,
                    Origin_country: vector["Origin_country"],
                    Longitude: vector["Longitude"],
                    Latitude: vector["Latitude"],
                    True_track: vector["True_track"]
                };

                pointGraphics = new Graphic({
                    geometry: points,
                    symbol: marker,
                    attributes: attributes
                });

                featureLayer = new FeatureLayer({
                    source: [pointGraphics],
                    supportsEditing: true,
                    supportsAdd: true,
                    fields: fields,
                    objectIdField: "Icao24",
                    renderer: rotationRenderer,
                    geometryType: "point",
                    spatialReference: {
                        wkid: 3857
                    }
                });

                map.add(featureLayer);

                async function applyEditsToLayer(edits) {
                    featureLayer
                        .applyEdits(edits)
                        .then(function (results) {
                            if (results.deleteFeatureResults.length > 0) {
                                console.log(
                                    results.deleteFeatureResults.length,
                                    "features have been removed"
                                );
                            }
                            if (results.addFeatureResults.length > 0) {
                                let objectIds = [];
                                results.addFeatureResults.forEach(function (item) {
                                    objectIds.push(item.objectId);
                                });
                                featureLayer
                                    .queryFeatures({
                                        objectIds: objectIds
                                    })
                                    .then(function (results) {
                                        console.log(
                                            results.features.length +
                                            " features have been added"
                                        );
                                    });
                            }
                        })
                }

                let removeFeatures = async (callback) => {
                    featureLayer.queryFeatures().then(function (results) {
                        const deleteEdits = {
                            deleteFeatures: results.features
                        };
                        applyEditsToLayer(deleteEdits).then(() => {
                            console.log("starting add features");
                            if (callback) {
                                callback ();
                            }
                        })
                    });
                }

                function addFeatures(graphics) {
                    const addEdits = {
                        addFeatures: []
                    };

                    console.log("graphics length: " + graphics.length);

                    if (graphics) {
                        graphics.forEach(function (item) {
                            addEdits.addFeatures.push(item)
                        })
                    }

                    applyEditsToLayer(addEdits);
                }

                async function addVectors(vectors) {
                    let attributes = {};
                    let pointGraphics = [];
                    console.log("first vector: " + vectors[0])
                    const vectorQuantity = vectors.length;
                    console.log("time = "+ vectors[0][0] + ", vectorQuantity: " + vectorQuantity);
                    for (let i = 0; i < vectorQuantity; i ++) {
                        points[vectors[i][1]] = {
                            type: "point",
                            longitude: vectors[i][6],
                            latitude: vectors[i][7]
                        };

                        attributes[vectors[i][1]] = {
                            Icao24: vectors[i][1],
                            Callsign: vectors[i][2],
                            Origin_country: vectors[i][3],
                            Longitude: vectors[i][6],
                            Latitude: vectors[i][7],
                            Baro_altitude: vectors[i][8],
                            Velocity: vectors[i][10],
                            True_track: vectors[i][11],
                            Vertical_rate: vectors[i][12],
                            Geo_altitude: vectors[i][14]
                        };

                        popupTemplates[vectors[i][1]] = {
                            title: "Aircraft information",
                            content:
                                `<ul><li>Icao24: ${attributes[vectors[i][1]].Icao24}</li>` +
                                `<li>Callsign: ${attributes[vectors[i][1]].Callsign}</li>` +
                                `<li>Origin_country: ${attributes[vectors[i][1]].Origin_country}</li>` +
                                `<li>Longitude: ${attributes[vectors[i][1]].Longitude}</li>` +
                                `<li>Latitude: ${attributes[vectors[i][1]].Latitude}</li>` +
                                `<li>Baro_altitude: ${attributes[vectors[i][1]].Baro_altitude}</li>` +
                                `<li>Velocity: ${attributes[vectors[i][1]].Velocity}</li></ul>`
                        };

                        pointGraphics.push(
                            new Graphic({
                                geometry: points[vectors[i][1]],
                                symbol: marker,
                                attributes: attributes[vectors[i][1]],
                                popupTemplate: popupTemplates[vectors[i][1]]
                            })
                        );
                    }
                    return pointGraphics
                }

                updateGraphics = function (vectors) {
                    console.log("updateGraphics() has started");
                    addVectors(vectors).then((graphics) => {
                        console.log("addVectors finished")
                        console.log("pointGraphics inside updateGraphics(): " + graphics);
                        removeFeatures (function () {
                            addFeatures (graphics);
                        })
                    })
                };

                // updateGraphics = function (vectors) {
                //     graphicLayer.removeAll();
                //
                //     var vectorQuantity = vectors.length;
                //     console.log("vectorQuantity time = "+ vectors[0][0] + ": " + vectorQuantity);
                //
                //     for (var i = 0; i < vectorQuantity; i ++) {
                //         points[vectors[i][1]] = {
                //             type: "point",
                //             longitude: vectors[i][6],
                //             latitude: vectors[i][7]
                //         };
                //
                //         attributes[vectors[i][1]] = {
                //             Icao24: vectors[i][1],
                //             Callsign: vectors[i][2],
                //             Origin_country: vectors[i][3],
                //             Longitude: vectors[i][6],
                //             Latitude: vectors[i][7],
                //             Baro_altitude: vectors[i][8],
                //             Velocity: vectors[i][10],
                //             True_track: vectors[i][11],
                //             Vertical_rate: vectors[i][12],
                //             Geo_altitude: vectors[i][14]
                //         };
                //
                //         popupTemplates[vectors[i][1]] = {
                //             title: "Aircraft information",
                //             content:
                //                 `<ul><li>Icao24: ${attributes[vectors[i][1]].Icao24}</li>` +
                //                 `<li>Callsign: ${attributes[vectors[i][1]].Callsign}</li>` +
                //                 `<li>Origin_country: ${attributes[vectors[i][1]].Origin_country}</li>` +
                //                 `<li>Longitude: ${attributes[vectors[i][1]].Longitude}</li>` +
                //                 `<li>Latitude: ${attributes[vectors[i][1]].Latitude}</li>` +
                //                 `<li>Baro_altitude: ${attributes[vectors[i][1]].Baro_altitude}</li>` +
                //                 `<li>Velocity: ${attributes[vectors[i][1]].Velocity}</li>`
                //         };
                //
                //         pointGraphics[vectors[i][1]] = new Graphic({
                //             geometry: points[vectors[i][1]],
                //             symbol: marker,
                //             attributes: attributes[vectors[i][1]],
                //             popupTemplate: popupTemplates[vectors[i][1]]
                //         });
                //     };
                //
                //     for (var key in pointGraphics) {
                //         graphicLayer.add(pointGraphics[key])
                //     };
                // };




                // const graphic = {
                //     popupTemplate: {
                //     content: "Mouse over features to show details..."
                //     }
                // };
                //
                // const feature = new Feature({
                //     container: "feature-node",
                //     graphic: graphic,
                //     map: view.map,
                //     spatialReference: view.spatialReference
                // });
                //
                // view.whenLayerView(graphicLayer).then(function (layerView) {
                //     let highlight;
                //     view.on("pointer-move", function (event) {
                //         view.hitTest(event).then(function (response) {
                //             let results = response.results;
                //             let result = results[0];
                //             highlight && highlight.remove();
                //             if (result) {
                //                 feature.graphic = result.graphic;
                //                 highlight = layerView.highlight(result.graphic);
                //             } else {
                //                 feature.graphic = graphic;
                //             }
                //         });
                //     });
                // });

            });
    </script>

    <script type="text/javascript">
        $(document).ready(function(){
            var socket = io({transports: ['websocket']});

            socket.on('connect', data => {
                console.log('client: connected');
            });

            socket.on('message', data => {
                updateGraphics(data);
            });
        });
    </script>

</head>

<body>
    <div class="container">
        <div class="bird">
            <i class="fas fa-kiwi-bird fa-2x"></i>
        </div>
        <h1>MyFly</h1>
        <div class="item">
            <a id="about" href="{{  url_for('.about') }}">About MyFly</a>
        </div>
        <div class="item">
            <a id="about" href="{{ url_for('.contacts') }}">Contacts</a>
        </div>
    </div>
    <div>
        <div id="feature-node" class="esri-widget"></div>
        <div id="viewDiv"></div>
        <div class="shadow"></div>

    </div>
    <div class="footer">
        Icons made by <a id="about" href="http://www.freepik.com/" title="Freepik">Freepik</a>
        from <a id="about" href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a>
    </div>

</body>

