<!doctype html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href='https://fonts.googleapis.com/css?family=Cambay' rel='stylesheet'>
    <title>MyFly</title>
    <style>
        html, body {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            background-color: #1E2224;
            color: white;
            font-family: 'Cambay', Helvetica;
            font-size: 22px;
        }
        .container {
            margin-top: 10px;
            width: 900px;
            padding: 10px;
        }
        .bird {
            width: 50px;
            padding: 10px;
            display: inline-block;
            vertical-align: sub;
            text-align: middle;
        }
        h1 {
            margin: 2px;
            display: inline-block;
            vertical-align: middle
        }
        a {
            color: inherit;
            text-decoration: none;
        }
        .item {
            width: 150px;
            display: inline-block;
            vertical-align: sub;
            text-align: center;
            font-size: 22px;
        }
        .shadow {
            box-shadow: 0px 10px 10px 0px inset #1B1E20;
            position: relative;
            content: "";
            height: 20px;
            z-index: 2;
        }
        #viewDiv {
            position: absolute;
            padding: 0px;
            margin: 0px;
            height: 96%;
            width: 100%;
            z-index: 1;
        }
        .esri-popup__header {
            color: #ffffff;
            cursor: default;
            line-height: 20px;
            background: rgba(30, 34, 36, 1) !important;
        }
        #feature-node {
            position: absolute;
            float: left;
            width: 25%;
            height: 100%;
            padding: 1em;
            z-index: 1;
            background: rgba(0, 0, 0, 1)
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://kit.fontawesome.com/2ddda9be5b.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"
            integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I="
            crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://js.arcgis.com/4.16/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.16/"></script>


    <script type="text/javascript">
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/widgets/Feature",
            "esri/layers/FeatureLayer"
            ], function(Map, MapView, Graphic, Feature, FeatureLayer) {

                var map = new Map({
                    basemap: "dark-gray-vector"
                });

                var view = new MapView({
                    container: "viewDiv",
                    map: map,
                    center: [-50.80500, 34.02700], // longitude, latitude
                    zoom: 2,
                    popup: {
                    autoOpenEnabled: false
                    }
                });

                featureLayer = new FeatureLayer();
                map.add(featureLayer);

                var marker = {
                    type: "picture-marker",
                    url: "https://arcgis.github.io/arcgis-samples-javascript/sample-data/cat3.png",
                    width: 30,
                    height: 30
                };

                var points = {};
                var attributes = {};
                var popupTemplates = {};
                var pointGraphics = {};

                updateGraphics = function (vectors) {
                    featureLayer.removeAll();

                    var vectorQuantity = vectors.length;
                    console.log("vectorQuantity time = "+ vectors[0][0] + ": " + vectorQuantity);

                    for (var i = 0; i < vectorQuantity; i ++) {
                        points[vectors[i][1]] = {
                            type: "point",
                            longitude: vectors[i][6],
                            latitude: vectors[i][7]
                        };

                        attributes[vectors[i][1]] = {
                            Icao24: vectors[i][1],
                            Callsign: vectors[i][2],
                            Origin_country: vectors[i][3],
                            Longitude: vectors[i][6],
                            Latitude: vectors[i][7],
                            Baro_altitude: vectors[i][8],
                            Velocity: vectors[i][10],
                            True_track: vectors[i][11],
                            Vertical_rate: vectors[i][12],
                            Geo_altitude: vectors[i][14]
                        };

                        popupTemplates[vectors[i][1]] = {
                            title: "Aircraft information",
                            content:
                                `<ul><li>Icao24: ${attributes[vectors[i][1]].Icao24}</li>` +
                                `<li>Callsign: ${attributes[vectors[i][1]].Callsign}</li>` +
                                `<li>Origin_country: ${attributes[vectors[i][1]].Origin_country}</li>` +
                                `<li>Longitude: ${attributes[vectors[i][1]].Longitude}</li>` +
                                `<li>Latitude: ${attributes[vectors[i][1]].Latitude}</li>` +
                                `<li>Baro_altitude: ${attributes[vectors[i][1]].Baro_altitude}</li>` +
                                `<li>Velocity: ${attributes[vectors[i][1]].Velocity}</li>`
                        };

                        pointGraphics[vectors[i][1]] = new Graphic({
                            geometry: points[vectors[i][1]],
                            symbol: marker,
                            attributes: attributes[vectors[i][1]],
                            popupTemplate: popupTemplates[vectors[i][1]]
                        });
                    };

                    for (var key in pointGraphics) {
                        featureLayer.add(pointGraphics[key])
                    };
                };

                const graphic = {
                    popupTemplate: {
                    content: "Mouse over features to show details..."
                    }
                };

                const feature = new Feature({
                    container: "feature-node",
                    graphic: graphic,
                    map: view.map,
                    spatialReference: view.spatialReference
                });

                view.whenLayerView(featureLayer).then(function (layerView) {
                    let highlight;
                    view.on("pointer-move", function (event) {
                        view.hitTest(event).then(function (event) {
                            let results = event.results.filter(function (result) {
                                return result.graphic.featureLayer.popupTemplate;
                            });
                            let result = results[0];
                            highlight && highlight.remove();
                            if (result) {
                                feature.graphic = result.graphic;
                                highlight = layerView.highlight(result.graphic);
                            } else {
                                feature.graphic = graphic;
                            }
                        });
                    });
                });

            });
    </script>

    <script type="text/javascript">
        $(document).ready(function(){
            var socket = io({transports: ['websocket']});

            socket.on('connect', data => {
                console.log('client: connected');
            });

            socket.on('message', data => {
                updateGraphics(data);
            });
        });
    </script>

</head>

<body>
    <div class="container">
        <div class="bird">
            <i class="fas fa-kiwi-bird fa-2x"></i>
        </div>
        <h1>MyFly</h1>
        <div class="item">
            <a href="{{  url_for('.about') }}">About MyFly</a>
        </div>
        <div class="item">
            <a href="{{ url_for('.contacts') }}">Contacts</a>
        </div>
    </div>
    <div>
        <div id="feature-node" class="esri-widget"></div>
        <div id="viewDiv"></div>
        <div class="shadow"></div>
    </div>

</body>

